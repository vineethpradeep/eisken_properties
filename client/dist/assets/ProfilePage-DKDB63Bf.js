import{j as e,P as S,r as i,h as M,S as z,I as v,q as _,T as Y,g as Z,J as H,B as f,L as I,A as w,U as J}from"./index-ChpVydyW.js";import{C as X}from"./Card-aWQjsNho.js";import{u as G}from"./useNotificationStore-BidOUctx.js";function D({posts:s}){return e.jsx("div",{className:"list",children:s.map(a=>e.jsx(X,{item:a},a.id))})}D.propTypes={posts:S.array.isRequired};var K=["second","minute","hour","day","week","month","year"];function Q(s,a){if(a===0)return["just now","right now"];var t=K[Math.floor(a/2)];return s>1&&(t+="s"),[s+" "+t+" ago","in "+s+" "+t]}var W=["秒","分钟","小时","天","周","个月","年"];function ee(s,a){if(a===0)return["刚刚","片刻后"];var t=W[~~(a/2)];return[s+" "+t+"前",s+" "+t+"后"]}var U={},T=function(s,a){U[s]=a},se=function(s){return U[s]||U.en_US},E=[60,60,24,7,365/7/12,12];function ae(s){return s instanceof Date?s:!isNaN(s)||/^\d+$/.test(s)?new Date(parseInt(s)):(s=(s||"").trim().replace(/\.\d+/,"").replace(/-/,"/").replace(/-/,"/").replace(/(\d)T(\d)/,"$1 $2").replace(/Z/," UTC").replace(/([+-]\d\d):?(\d\d)/," $1$2"),new Date(s))}function re(s,a){var t=s<0?1:0;s=Math.abs(s);for(var d=s,n=0;s>=E[n]&&n<E.length;n++)s/=E[n];return s=Math.floor(s),n*=2,s>(n===0?9:1)&&(n+=1),a(s,n,d)[t].replace("%s",s.toString())}function te(s,a){var t=new Date;return(+t-+ae(s))/1e3}var ne=function(s,a,t){var d=te(s);return re(d,se(a))};T("en_US",Q);T("zh_CN",ee);function $({chats:s}){var m,N;const[a,t]=i.useState(null),{currentUser:d}=i.useContext(M),{socket:n}=i.useContext(z),x=i.useRef(),h=G(r=>r.decrease);i.useEffect(()=>{var r;(r=x.current)==null||r.scrollIntoView({behavior:"smooth"})},[a]);const u=async(r,o)=>{try{const c=await v("/chats/"+r);c.data.seenBy.includes(d.id)||h(),t({...c.data,receiver:o})}catch(c){console.log(c)}},j=async r=>{r.preventDefault();const c=new FormData(r.target).get("text");if(c)try{const g=await v.post("/messages/"+a.id,{text:c});t(y=>({...y,messages:[...y.messages,g.data]})),r.target.reset(),n.emit("sendMessage",{receiverId:a.receiver.id,data:g.data})}catch(g){console.log(g)}};return i.useEffect(()=>{const r=async()=>{try{await v.put("/chats/read/"+a.id)}catch(o){console.log(o)}};return a&&n&&n.on("getMessage",o=>{a.id===o.chatId&&(t(c=>({...c,messages:[...c.messages,o]})),r())}),()=>{n.off("getMessage")}},[n,a]),e.jsxs("div",{className:"chat",children:[e.jsxs("div",{className:"messages",children:[e.jsx("h1",{children:"Messages"}),s.map(r=>{var o,c;return e.jsxs("div",{className:"message",style:{backgroundColor:r.seenBy.includes(d.id)||(a==null?void 0:a.id)===r.id?"white":"#edac15"},onClick:()=>u(r.id,r.receiver),children:[e.jsx("img",{src:((o=r.receiver)==null?void 0:o.avatar)||"images/blankProfile.png",alt:"Profile Image"}),e.jsx("span",{children:(c=r.receiver)==null?void 0:c.username}),e.jsx("p",{children:r.lastMessage})]},r.id)})]}),a&&e.jsxs("div",{className:"chatBox",children:[e.jsxs("div",{className:"top",children:[e.jsxs("div",{className:"user",children:[e.jsx("img",{src:((m=a.receiver)==null?void 0:m.avatar)||"images/blankProfile.png",alt:"Chat User Image"}),(N=a.receiver)==null?void 0:N.username]}),e.jsx("span",{className:"close",onClick:()=>t(null),children:"X"})]}),e.jsxs("div",{className:"center",children:[a.messages.map(r=>e.jsxs("div",{className:"chatMessage",style:{alignSelf:r.userId===d.id?"flex-end":"flex-start",textAlign:r.userId===d.id?"right":"left"},children:[e.jsx("p",{children:r.text}),e.jsx("span",{children:ne(r.createdAt)})]},r.id)),e.jsx("div",{ref:x})]}),e.jsxs("form",{onSubmit:j,className:"bottom",children:[e.jsx("textarea",{name:"text"}),e.jsx("button",{children:"Send"})]})]})]})}$.propTypes={chats:S.array};const F=({usersLists:s,onDeleteUser:a})=>{const[t,d]=i.useState(""),n=_();console.log(s);const x=async h=>{var u,j;try{const m=await v.delete(`users/${h}`);a(m.data),n("/profile")}catch(m){console.log(m),d(((j=(u=m.response)==null?void 0:u.data)==null?void 0:j.message)||"User delete error occurred.")}};return e.jsxs("div",{className:"table-container",children:[e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Action"})]})}),e.jsx("tbody",{children:s.map(h=>e.jsxs("tr",{children:[e.jsx("td",{children:`${h.username} ${h.isAdmin?" -  (Admin)":""}`}),e.jsx("td",{children:h.email}),e.jsx("td",{children:!h.isAdmin&&e.jsx("span",{className:"delete-icon",onClick:()=>x(h.id),children:e.jsx(Y,{})})})]},h.id))})]}),t&&e.jsx("span",{children:t})]})};F.propTypes={usersLists:S.array.isRequired,onDeleteUser:S.func.isRequired};function ce(){var k;const s=Z();console.log(s);const{currentUser:a,updateUser:t}=i.useContext(M),[d,n]=i.useState(!1),[x,h]=i.useState(""),[u,j]=i.useState(a==null?void 0:a.avatar),[m,N]=i.useState(((k=s.getUsersResponse)==null?void 0:k.data)||[]),r=_(),o=()=>n(!d),c=async()=>{try{await v.post("/auth/logout"),t(null),localStorage.removeItem("user"),r("/login")}catch(l){console.log(l)}},g=async l=>{var P,R;l.preventDefault();const b=new FormData(l.target),q=Object.fromEntries(b.entries()),{username:B,email:O,password:V}=q;let C=null;const A=b.get("avatar");if(A){const p=new FormData;p.append("file",A),p.append("upload_preset","realEstate"),p.append("folder","avatar");try{C=(await J.post("https://api.cloudinary.com/v1_1/eiskenproperties/image/upload",p)).data.secure_url,console.log("Uploaded Avatar URL:",C),j(C)}catch(L){console.error("Error uploading to Cloudinary:",L),h("Failed to upload avatar. Please try again.");return}}try{const p=await v.put(`users/${a.id}`,{username:B,email:O,password:V,avatar:C});t(p.data),o()}catch(p){console.log(p),h(((R=(P=p.response)==null?void 0:P.data)==null?void 0:R.message)||"An error occurred.")}},y=l=>{N(m.filter(b=>b.id!==l))};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"wrapper-profile",children:e.jsxs("div",{className:"profilePage",children:[e.jsx("div",{className:"details",children:e.jsxs("div",{className:"wrapper-details",children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"User Information"}),!(a!=null&&a.googleId)&&e.jsx(f,{variant:"primary",onClick:o,children:"Update Profile"})]}),e.jsxs("div",{className:"info",children:[e.jsxs("span",{children:["Avatar:",e.jsx("img",{src:u||"images/blankProfile.png",alt:"Avatar Image"})]}),e.jsxs("span",{children:["Username: ",e.jsx("b",{children:a.username})]}),e.jsxs("span",{children:["E-mail: ",e.jsx("b",{children:a.email})]}),e.jsx(f,{variant:"secoundary",onClick:c,children:"Logout"})]}),(a==null?void 0:a.isAdmin)&&e.jsxs("div",{className:"userTableContainer",children:[e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"Creat User"}),e.jsx(I,{to:"/register",children:e.jsx(f,{variant:"primary",children:"Create New User"})})]}),e.jsx(i.Suspense,{fallback:e.jsx("p",{children:"Loading..."}),children:e.jsx(w,{resolve:s.getUsersResponse,errorElement:e.jsx("p",{children:"Error loading user!"}),children:l=>e.jsx(F,{usersLists:l.data,onDeleteUser:y})})})]}),e.jsxs("div",{className:"title",children:[e.jsx("h1",{children:"My List"}),e.jsx(I,{to:"/add",children:e.jsx("button",{children:"Create New Post"})})]}),e.jsx(i.Suspense,{fallback:e.jsx("p",{children:"Loading..."}),children:e.jsx(w,{resolve:s.postResponse,errorElement:e.jsx("p",{children:"Error loading posts!"}),children:l=>e.jsx(D,{posts:l.data.userPosts})})}),e.jsx("div",{className:"title",children:e.jsx("h1",{children:"Saved List"})}),e.jsx(i.Suspense,{fallback:e.jsx("p",{children:"Loading..."}),children:e.jsx(w,{resolve:s.postResponse,errorElement:e.jsx("p",{children:"Error loading posts!"}),children:l=>e.jsx(D,{posts:l.data.savedPosts})})})]})}),e.jsx("div",{className:"chatContainer",children:e.jsx("div",{className:"wrapper-chat",children:e.jsx(i.Suspense,{fallback:e.jsx("p",{children:"Loading..."}),children:e.jsx(w,{resolve:s.chatResponse,errorElement:e.jsx("p",{children:"Error loading chats!"}),children:l=>e.jsx($,{chats:l.data})})})})})]})}),d&&H.createPortal(e.jsx("div",{className:"modal-overlay",onClick:o,children:e.jsxs("div",{className:"modal-content",onClick:l=>l.stopPropagation(),children:[e.jsx("h2",{className:"modal-title",children:"Update Your Details"}),x&&e.jsx("span",{children:x}),e.jsxs("form",{className:"form",onSubmit:g,children:[e.jsxs("label",{className:"form-label",children:["Name:",e.jsx("input",{type:"text",name:"username",defaultValue:a.username,placeholder:a.username,className:"form-input"})]}),e.jsxs("label",{className:"form-label",children:["Email:",e.jsx("input",{type:"email",name:"email",defaultValue:a.email,placeholder:a.email,className:"form-input"})]}),e.jsxs("label",{className:"form-label",children:["Password:",e.jsx("input",{type:"password",name:"password",placeholder:"Enter your password",className:"form-input"})]}),e.jsxs("label",{className:"form-label",children:["Avatar:",e.jsx("input",{type:"file",name:"avatar",className:"form-input",accept:"image/*"})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx(f,{variant:"primary",type:"submit",children:"Update"}),e.jsx(f,{variant:"secondary",onClick:o,children:"Cancel"})]})]})]})}),document.body)]})}export{ce as default};
